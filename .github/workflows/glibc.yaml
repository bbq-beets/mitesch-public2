name: glibc
# This workflow tests examples from the examples directory of this repo.

on:
  workflow_dispatch:
    inputs:
      version:
        default: glibc-2.35

jobs:
  do-test:
    strategy:
      fail-fast: false
      matrix:
        version: [  glibc-2.35 ]
        testNum: [1] #[1,2,3,4,5,6,7,8,9,10]
        os: [ ubuntu-22.04-arm ]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 25
    steps:
      - name: vm info
        run: |
          curl -s -H Metadata:true --noproxy "*" "http://169.254.169.254/metadata/instance?api-version=2021-02-01" | jq      
          echo '::warning:: ' $(curl -s -H Metadata:true --noproxy "*" "http://169.254.169.254/metadata/instance?api-version=2021-02-01" | jq | grep "vmSize")
          sudo sysctl -w kernel.print-fatal-signals=1

      - name: clone glibc
        run: |
          mkdir $HOME/src
          cd $HOME/src
          git clone https://git.launchpad.net/~ubuntu-core-dev/ubuntu/+source/glibc glibc
          cd glibc
          git checkout ${{ matrix.version }}
          mkdir -p $HOME/build/glibc
        
      - name: build glibc
        run: |
          cd $HOME/build/glibc
          sed -i 's/^# PARALLELMFLAGS/PARALLELMFLAGS/' $HOME/src/glibc/Makefile.in
          $HOME/src/glibc/configure --prefix=/usr
          make

      - uses: actions/checkout@v4
      - name: test rustc
        run: |
          cd $GITHUB_WORKSPACE
          pipx install pyyaml
          chown +x runtasks.py
          ./runtasks.py -q  tasks-ubuntuglibc-239.yml 


